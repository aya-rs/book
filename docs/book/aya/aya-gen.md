# Using aya-gen

!!! example "Source Code"

    Full code for the example in this chapter is availble [here](https://github.com/aya-rs/book/tree/main/examples/aya-gen)

Very often you will need to use type definitions that your running Linux kernel
uses in its source code. For example, you might need a definition of
[task_struct](https://elixir.bootlin.com/linux/v5.15.3/source/include/linux/sched.h#L723),
because you are about to write a BPF program which receives an
information about new scheduled process/task. Aya doesn't provide any
definition of this structure. What should be done to get that definition? And
we also need that definition in Rust, not in C.

That's what aya-gen is designed for. It's a tool which allows to generate Rust
bindings for specific kernel structures.

It can be installed with the following command:

```console
$ cargo install --git https://github.com/aya-rs/aya -- aya-gen
```

Ensure that you have `bpftool` installed in your system, `aya-gen` is not going
to work without it.

The syntax of the command is:

```console
$ aya-gen
aya-gen 0.1.0

USAGE:
    aya-gen <SUBCOMMAND>

FLAGS:
    -h, --help       Prints help information
    -V, --version    Prints version information

SUBCOMMANDS:
    generate
    help         Prints this message or the help of the given subcommand(s)
```

Let's assume that we want to generate Rust definition of
[task_struct](https://elixir.bootlin.com/linux/v5.15.3/source/include/linux/sched.h#L723).
Let's also assume that your project is called `myapp`. Your userspace part is
in `myapp` subdirectory, your eBPF part is in `myapp-ebpf`. We need to generate
the bindings for the eBPF part, which can be done with:

```console
$ aya-gen generate task_struct > myapp-ebpf/src/vmlinux.rs
```

!!! tip "Generating for multiple types"

    You can also specify multiple types to generate, for example:
    ```console
    $ aya-gen generate task_struct dentry > vmlinux.rs
    ```
    But in the following example, we will focus only on `task_struct`.

Then we can use `vmlinux` as a module with `mod vmlinux` in our eBPF program,
like here:

```rust linenums="1" title="myapp-ebpf/src/main.rs"
--8<-- "examples/aya-gen/myapp-ebpf/src/main.rs"
```

## Portability and different kernel versions

Structures generated by aya-gen are portable across different Linux kernel
versions thanks to mechanism called
[BPF CO-RE](https://facebookmicrosites.github.io/bpf/blog/2020/02/19/bpf-portability-and-co-re.html).
The structures are not simply generated from kernel headers. However, the
target kernel (regardless of version) should have `CONFIG_DEBUG_INFO_BTF`
option enabled.
